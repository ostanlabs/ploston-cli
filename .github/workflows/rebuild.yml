# =============================================================================
# Rebuild on Core Update (Cascade)
# =============================================================================
# Triggered by meta-repo when ploston-core is updated.
# Runs tests with the new core version and reports back.
#
# Flow:
#   1. Meta-repo dispatches 'rebuild' event with cascade_id and core_version
#   2. This workflow runs tests with the new core version
#   3. Dispatches 'build-complete' back to meta-repo with results
#
# Note: ploston-cli is a PyPI package, not a Docker image.
# =============================================================================

name: Rebuild (Cascade)

on:
  repository_dispatch:
    types: [rebuild]

concurrency:
  group: ${{ github.repository }}-builds
  cancel-in-progress: true

jobs:
  rebuild:
    name: Test with new ploston-core
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Create venv and install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Wait for ploston-core on PyPI
        env:
          GH_TOKEN: ${{ secrets.META_REPO_TOKEN }}
        run: |
          CORE_VERSION="${{ github.event.client_payload.core_version }}"
          # Fetch the wait script from meta-repo
          curl -sL \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/ostanlabs/agent-execution-layer/contents/ci/scripts/wait-for-pypi.sh?ref=main" \
            -o wait-for-pypi.sh
          chmod +x wait-for-pypi.sh
          ./wait-for-pypi.sh ploston-core "$CORE_VERSION"

      - name: Install specific ploston-core version
        run: |
          CORE_VERSION="${{ github.event.client_payload.core_version }}"
          uv pip install "ploston-core==$CORE_VERSION"

      - name: Run unit tests
        run: uv run pytest tests/unit/ -v --tb=short --junitxml=junit-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: junit-results.xml

  report-success:
    name: Report Success to Meta-Repo
    needs: [rebuild]
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch build-complete (success)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: build-complete
          client-payload: |
            {
              "cascade_id": "${{ github.event.client_payload.cascade_id }}",
              "repo": "ploston-cli",
              "sha": "${{ github.sha }}",
              "core_version": "${{ github.event.client_payload.core_version }}",
              "status": "success",
              "error": null,
              "artifact": {
                "package": {
                  "name": "ploston-cli",
                  "version": "dev"
                }
              }
            }

  report-failure:
    name: Report Failure to Meta-Repo
    needs: [rebuild]
    if: failure()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Dispatch build-complete (failure)
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: build-complete
          client-payload: |
            {
              "cascade_id": "${{ github.event.client_payload.cascade_id }}",
              "repo": "ploston-cli",
              "sha": "${{ github.sha }}",
              "core_version": "${{ github.event.client_payload.core_version }}",
              "status": "failure",
              "error": "Tests failed - check workflow run for details",
              "artifact": null
            }

